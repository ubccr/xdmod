#!/bin/bash

function start_services() {
    /usr/sbin/postfix start
    httpd -k start
    php-fpm
}

function stop_services() {
    httpd -k stop
    /usr/sbin/postfix stop
    pkill php-fpm
}

case "$1" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        $0 stop
        $0 start
        ;;
    nodaemon)
        $0 start
        while sleep 1; do

            /usr/sbin/postfix status >/dev/null 2>&1
            if [ $? -ne 0 ]; then
                echo "Postfix not running"
                shouldDie=1
            fi

            # Double check to see if pidof is installed.
            which pidof &>/dev/null
            if [ $? -eq 0 ]; then
                pidof httpd >/dev/null 2>&1
                if [ $? -ne 0 ]; then
                    echo "httpd not running"
                    shouldDie=1
                fi

                pidof php-fpm >/dev/null 2>&1
                if [ $? -ne 0 ]; then
                    echo "php-fpm not running"
                    shouldDie=1
                fi
            fi

            if [ $shouldDie -ne 0 ]; then
                exit 1
            fi
        done
        ;;
esac
