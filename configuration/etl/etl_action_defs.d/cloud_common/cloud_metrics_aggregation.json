{
    "#": "Aggregation of Cloud Data ingested from Eucalyptus",
        "table_definition": {
            "name": "cloud_fact_by_",
            "table_prefix": "cloud_fact_by_",
            "engine": "MyISAM",
            "comment": "Euca facts aggregated by ${AGGREGATION_UNIT}.",
            "columns": [
                {
                    "name": "${AGGREGATION_UNIT}_id",
                    "type": "int(10) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The id related to modw.${AGGREGATION_UNIT}s."
                },{
                    "name": "year",
                    "type": "smallint(5) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The year of the ${AGGREGATION_UNIT}"
                },{
                    "name": "${AGGREGATION_UNIT}",
                    "type": "smallint(5) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The ${AGGREGATION_UNIT} of the year."
                },{
                    "name": "host_resource_id",
                    "type": "int(11) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The resource id of the host of a VM where event(s) occured."
                },{
                    "name": "account_id",
                    "type": "smallint(5) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The account id associated with the VM."
                },{
                    "name": "person_id",
                    "type": "int(11) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: The person id associated with a VM instance."
                },{
                    "name": "processorbucket_id",
                    "type": "int(4)",
                    "nullable": true,
                    "comment": "FACT: Pre-determined processor bucket sizes. References processorbucket.id"
                },{
                    "name": "memorybucket_id",
                    "type": "int(4)",
                    "nullable": true,
                    "comment": "FACT: Pre-determined memory bucket sizes. References memorybucket.id"
                },{
                    "name": "instance_type_id",
                    "type": "int(11) unsigned",
                    "nullable": false,
                    "comment": "DIMENSION: Type of instance on which an event occurred."
                },{
                    "name": "configuration",
                    "type": "varchar(256)",
                    "nullable": false,
                    "comment": "DIMENSION: configuration name of a VM configuration."
                },{
                    "name": "num_cores",
                    "type": "int(11)",
                    "nullable": false,
                    "comment": "DIMENSION: Number of cores on a VM."
                },{
                    "name": "core_time",
                    "type": "bigint(42)",
                    "nullable": false,
                    "comment": "FACT: Core hours reserved by a VM."
                },{
                    "name": "memory_reserved",
                    "type": "bigint(42)",
                    "nullable": false,
                    "comment": "FACT: Memory reserved by a VM."
                },{
                    "name": "disk_reserved",
                    "type": "bigint(42)",
                    "nullable": false,
                    "comment": "FACT: Disk space reserved by a VM."
                },{
                    "name": "memory_mb",
                    "type": "int(11)",
                    "nullable": false,
                    "comment": "DIMENSION: Amount of memory in MB reserved by a VM."
                },{
                    "name": "disk_gb",
                    "type": "int(11)",
                    "nullable": false,
                    "comment": "DIMENSION: Disk size in GB reserved by a VM."
                },{
                    "name": "num_vms_running",
                    "type": "int(11)",
                    "nullable": true,
                    "comment": "FACT: Number of VMs extant in some fashion in a given period."
                },{
                    "name": "num_vms_started",
                    "type": "int(11)",
                    "nullable": true,
                    "comment": "FACT: Number of VMs started over a given period."
                },{
                    "name": "num_vms_ended",
                    "type": "int(11)",
                    "nullable": true,
                    "comment": "FACT: Number of VMs ended over a given period."
                },{
                    "name": "wallduration",
                    "type": "decimal(18,0)",
                    "nullable": true,
                    "comment": "FACT: (seconds) The wallduration of the VMs that were running during this period."
                }
            ],

        "indexes": [
            {
                "name": "index_account",
                "columns": [ "account_id" ]
            },{
                "name": "index_person",
                "columns": [ "person_id" ]
            },{
                "name": "index_resource",
                "columns": [ "host_resource_id" ]
            },{
                "name": "index_period_value",
                "columns": [ "${AGGREGATION_UNIT}" ]
            },{
                "name": "index_period",
                "columns": [ "${AGGREGATION_UNIT}_id" ]
            }]
        },
        "aggregation_period_query": {
            "overseer_restrictions": {
                "#last_modified_start_date": "last_modified >= ${VALUE}",
                "#last_modified_end_date": "last_modified <= ${VALUE}",
                "include_only_resource_codes": "resource_id IN ${VALUE}",
                "exclude_resource_codes": "resource_id NOT IN ${VALUE}"
            }
        },
        "destination_query": {
            "overseer_restrictions": {
                "include_only_resource_codes": "host_resource_id IN ${VALUE}",
                "exclude_resource_codes": "host_resource_id NOT IN ${VALUE}"
            }
        },
        "source_query": {
            "overseer_restrictions": {
                "include_only_resource_codes": "host.resource_id IN ${VALUE}",
                "exclude_resource_codes": "host.resource_id NOT IN ${VALUE}"
            },
            "records": {
                "${AGGREGATION_UNIT}_id": "${:PERIOD_ID}",
                "year": "${:YEAR_VALUE}",
                "${AGGREGATION_UNIT}": "${:PERIOD_VALUE}",
                "host_resource_id": "cet.resource_id",
                "account_id": "instance.account_id",
                "person_id": "instance.person_id",
                "processorbucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.processor_buckets pb WHERE cet.num_cores BETWEEN pb.min_processors AND pb.max_processors)",
                "memorybucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.memory_buckets mb WHERE cet.memory_mb BETWEEN mb.min_memory AND mb.max_memory)",
                "instance_type_id": "cet.instance_type_id",
                "configuration": "cet.configuration",
                "num_cores": "SUM(cet.num_cores)",
                "core_time": "COALESCE(SUM(cet.num_cores * ${wallduration_case_statement}), 0)",
                "memory_reserved": "COALESCE(SUM((cet.memory_mb * POW(1024, 2)) * ${wallduration_case_statement}), 0)",
                "disk_reserved": "COALESCE(SUM((cet.disk_gb * POW(1024, 3)) * ${wallduration_case_statement}), 0)",
                "memory_mb": "SUM(cet.memory_mb)",
                "disk_gb": "SUM(cet.disk_gb)",
                "num_vms_started": "SUM(IF(cet.start_day_id BETWEEN ${:PERIOD_START_DAY_ID} AND ${:PERIOD_END_DAY_ID} AND cet.start_event = 'START', 1, 0))",
                "num_vms_ended": "SUM(IF(cet.end_day_id BETWEEN ${:PERIOD_START_DAY_ID} AND ${:PERIOD_END_DAY_ID} AND cet.end_event = 'TERMINATE', 1, 0))",
                "num_vms_running": "SUM(1)",
                "wallduration": "COALESCE(SUM(${wallduration_case_statement}), 0)"
            },
            "groupby": [
              "${AGGREGATION_UNIT}_id",
              "year",
              "${AGGREGATION_UNIT}",
              "configuration",
              "processorbucket_id",
              "account_id",
              "person_id"
            ],
            "joins":[
              {
                  "name": "cloud_events_transient",
                  "alias": "cet",
                  "schema": "${SOURCE_SCHEMA}"
              },{
                  "name": "instance",
                  "schema": "${SOURCE_SCHEMA}",
                  "on": "instance.instance_id = cet.id and instance.resource_id = cet.resource_id"
              },{
                  "name": "resourcefact",
                  "schema": "${UTILITY_SCHEMA}",
                  "alias": "task_resource",
                  "on": "task_resource.id = cet.resource_id"
              }
            ],
            "where": [
              "cet.start_day_id <= ${:PERIOD_END_DAY_ID} AND cet.end_day_id >= ${:PERIOD_START_DAY_ID}",
              "cet.configuration != \"Unknown\"",
              "cet.instance !=\"Unknown\"",
              "cet.num_cores != 0"
          ],
            "macros": [{
                "name": "wallduration_case_statement",
                "file": "statistic_ratio_case.sql",
                "args": {
                    "statistic": "cet.wallduration",
                    "max": "${:PERIOD_SECONDS}",
                    "src_start_ts": "cet.start_time_ts",
                    "src_end_ts": "cet.end_time_ts",
                    "dest_start_ts": "${:PERIOD_START_TS}",
                    "dest_end_ts": "${:PERIOD_END_TS}"
                }
            }]
        }
}
